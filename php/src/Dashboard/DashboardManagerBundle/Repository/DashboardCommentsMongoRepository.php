<?php

namespace Dashboard\DashboardManagerBundle\Repository;

use Doctrine\ODM\MongoDB\DocumentRepository;

/**
 * DashboardCommentsMongoRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class DashboardCommentsMongoRepository extends DocumentRepository
{
    /**
    * comment lising
    * @param string $post_id
    * @param int $limit
    * @param int $offset
    * @return object array
    */
    public function getMyDashboardCommentList($post_id,$limit,$offset)
    {
            $qb     = $this->createQueryBuilder('User');
            $result = $qb
                            ->field('is_active')->equals(1)
                            ->field('post_id')->equals($post_id)
                            ->sort('id', 'ASC')
                            ->limit($limit)
                            ->skip($offset)
                            ->getQuery()
                            ->execute()
                            ->toArray(false);
            
            return $result;
    }
    /**
    * comment lising
    * @param string $post_id
    * @return object array
    */
    public function getMyDashboardCommentCount($post_id)
    {
            $qb     = $this->createQueryBuilder('User');
            $result = $qb
                            ->field('is_active')->equals(1)
                            ->field('post_id')->equals($post_id)
                            ->getQuery()
                            ->execute()
                            ->toArray(false);
            
            return $result;
    }
    
    /**
     * finding the commennts of posts.
     * @param type $post_ids
     * @return document object.
     */
    public function findPostsComments($post_ids) {
            $qb     = $this->createQueryBuilder('u');
            $result = $qb->field('is_active')->equals(1)
                         ->field('post_id')->in($post_ids)
                         ->sort('created_at','DESC')
                         ->getQuery()
                         ->execute()
                         ->toArray(false);
            return $result;
    }
    
    /**
     * Edit the comment rate
     * @param type $rate_id
     * @return boolean
     */
    public function editCommentRate($rate_id, $arrayCommentRate, $comment_id) {
        $result = $this->createQueryBuilder('DashboardComments')
                ->update()
                ->field('id')->equals($comment_id)
                ->field('rate.id')->equals($rate_id)
                ->field("rate.$")->set($arrayCommentRate)
                ->getQuery()
                ->execute();
        return true;
    }
    
    /**
     * finding the commennts of posts.
     * @param type $post_ids
     * @return document object.
     */
    public function getRecentPostsComments($post_ids,  $limitForEachPost=0) {
        $response = array();
        foreach ($post_ids as $post_id){
            $result = $this->findBy(array('post_id'=>$post_id, 'is_active'=>1), array('created_at'=>'DESC'), $limitForEachPost);
            $response = array_merge($response, $result);
        }
            return $response;
    }
    
    public function getCommentsByIds($commentIds){
        $qb     = $this->createQueryBuilder();
        $results = $qb
                ->field('id')->in($commentIds)
                ->getQuery()
                ->execute()
                ->toArray();
        return $results;
    }
    
}