<?php

namespace UserManager\Sonata\UserBundle\Entity;

use Doctrine\ORM\EntityRepository;

/**
 * BrokerUserRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class BrokerUserRepository extends EntityRepository
{
        /**
         * 
         * @param int $user_id
         */
        public function getExternalProfileBroker($user_id)
        {
             $response = array();
             $qb = $this->createQueryBuilder('c');
             $query = $qb->select('c.id, c.userId, c.phone, c.vatNumber, c.fiscalCode, c.iban')
                ->innerJoin('UserManagerSonataUserBundle:User', 'co', 'WITH', 'co.id = c.userId')
                ->where('c.userId =:uid','co.enabled =:isactive')
                ->setParameter('uid', $user_id)
                ->setParameter('isactive', 1)
                ->getQuery();
            
            $response = $query->getResult(); 
            if(count($response)>0){
         return $response[0]; 
         }
         return $response;
        }
        
        /**
         * broker user.
         */
        public function getBrokerProfile()
        {
            $sql = "SELECT u.id, username, email, firstname, REPLACE( IFNULL(u.lastname, ''), '\r\n' , '\n' ) as lastname, REPLACE( IFNULL(u.gender, ''), '\r\n' , '\n' ) as gender, 
                    REPLACE( IFNULL(b.phone, ''), '\r\n' , '\n' ) as phone, REPLACE( IFNULL(u.country, ''), '\r\n' , '\n' ) as country, 
                    REPLACE( IFNULL(DATE_FORMAT(u.date_of_birth, '%m/%d/%Y'), ''), '\r\n' , '\n' ) as dob, 
                    REPLACE( IFNULL(vat_number, ''), '\r\n' , '\n' ) as vatnumber, REPLACE( IFNULL(fiscal_code, ''), '\r\n' , '\n' ) as fiscalcode, REPLACE( IFNULL(iban, ''), '\r\n' , '\n' ) as iban,
                    REPLACE( IFNULL(map_place, ''), '\r\n' , '\n' ) as mapplace,
                    REPLACE( IFNULL(latitude, ''), '\r\n' , '\n' ) as latitude, REPLACE( IFNULL(longitude, ''), '\r\n' , '\n' ) as longitude, b.is_active as active, b.ssn as ssn
                    FROM brokeruser AS b
                    INNER JOIN fos_user_user AS u ON u.id = b.user_id";
             
            $stmt = $this->getEntityManager()
                   ->getConnection()
                   ->prepare($sql);
           $stmt->execute();
           $result = $stmt->fetchAll();
           return $result;            
        }
}
